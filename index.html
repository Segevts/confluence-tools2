<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Junction Workflow Wizard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #ffffff; min-height: 100vh; padding: 15px; }
        .wizard-container { max-width: 700px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 15px; }
        .header h1 { color: #172b4d; font-size: 20px; margin-bottom: 3px; }
        .header p { color: #6b778c; font-size: 13px; }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 15px; padding: 0 5px; }
        .progress-step { display: flex; flex-direction: column; align-items: center; flex: 1; position: relative; }
        .progress-step::after { content: ''; position: absolute; top: 12px; left: 50%; width: 100%; height: 2px; background: #dfe1e6; z-index: 0; }
        .progress-step:last-child::after { display: none; }
        .progress-circle { width: 24px; height: 24px; border-radius: 50%; background: #dfe1e6; color: #6b778c; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; z-index: 1; transition: all 0.3s; }
        .progress-step.active .progress-circle { background: #0052cc; color: white; }
        .progress-step.completed .progress-circle { background: #36b37e; color: white; }
        .progress-step.completed::after { background: #36b37e; }
        .progress-label { font-size: 10px; color: #6b778c; margin-top: 3px; }
        .card { background: #f4f5f7; border-radius: 8px; padding: 20px; display: none; }
        .card.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card h2 { color: #172b4d; font-size: 17px; margin-bottom: 5px; }
        .card .subtitle { color: #6b778c; font-size: 13px; margin-bottom: 18px; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 12px 16px; border: 2px solid #dfe1e6; border-radius: 6px; background: white; color: #172b4d; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; flex: 1; min-width: 90px; }
        .btn:hover { border-color: #0052cc; background: #f4f5f7; }
        .btn.selected { border-color: #0052cc; background: #deebff; color: #0052cc; }
        .btn-yes { border-color: #36b37e; color: #36b37e; }
        .btn-yes:hover, .btn-yes.selected { background: #e3fcef; border-color: #36b37e; color: #006644; }
        .btn-no { border-color: #de350b; color: #de350b; }
        .btn-no:hover, .btn-no.selected { background: #ffebe6; border-color: #de350b; color: #bf2600; }
        .country-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-bottom: 15px; }
        .country-btn { padding: 10px 6px; font-size: 12px; min-width: auto; }
        .road-type-btn { display: flex; flex-direction: column; align-items: center; padding: 15px 10px; min-width: 80px; }
        .road-type-btn .icon { font-size: 20px; margin-bottom: 5px; }
        .road-type-btn .label { font-size: 12px; font-weight: 500; }
        .road-type-btn .speed { font-size: 11px; color: #6b778c; margin-top: 3px; }
        .road-type-btn .detail { font-size: 9px; color: #97a0af; margin-top: 2px; text-align: center; }
        .result-card { background: linear-gradient(135deg, #0052cc 0%, #0747a6 100%); color: white; padding: 25px; border-radius: 8px; text-align: center; margin-bottom: 15px; }
        .result-card h3 { font-size: 14px; margin-bottom: 10px; opacity: 0.9; }
        .result-speed { font-size: 42px; font-weight: 700; margin-bottom: 3px; }
        .result-unit { font-size: 14px; opacity: 0.8; }
        .result-confidence { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); }
        .confidence-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 6px 16px; border-radius: 20px; font-size: 13px; }
        .summary { background: white; border-radius: 6px; padding: 15px; margin-bottom: 15px; }
        .summary h4 { color: #172b4d; font-size: 13px; margin-bottom: 12px; }
        .summary-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f4f5f7; font-size: 13px; }
        .summary-item:last-child { border-bottom: none; }
        .summary-label { color: #6b778c; }
        .summary-value { color: #172b4d; font-weight: 500; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 18px; padding-top: 15px; border-top: 1px solid #dfe1e6; }
        .nav-btn { padding: 10px 18px; border-radius: 5px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .nav-btn.back { background: white; border: 1px solid #dfe1e6; color: #6b778c; }
        .nav-btn.back:hover { background: #f4f5f7; }
        .nav-btn.reset { background: #de350b; border: none; color: white; }
        .nav-btn.reset:hover { background: #bf2600; }
        .info-box { background: #deebff; border-left: 3px solid #0052cc; padding: 12px; border-radius: 0 5px 5px 0; margin: 15px 0; font-size: 13px; }
        .info-box.success { background: #e3fcef; border-color: #36b37e; }
        .info-box.warning { background: #fffae6; border-color: #ff991f; }
        .info-box p { color: #172b4d; line-height: 1.4; }
        .exception-list { margin: 12px 0; }
        .exception-item { display: flex; align-items: center; padding: 10px 12px; background: white; border-radius: 5px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; font-size: 13px; }
        .exception-item:hover { background: #f4f5f7; }
        .exception-item input { margin-right: 10px; }
        .sub-options { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #dfe1e6; }
        .sub-options h3 { font-size: 14px; color: #172b4d; margin-bottom: 10px; }
        @media (max-width: 500px) { .btn-group { flex-direction: column; } .country-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="wizard-container">
        <div class="header">
            <h1>Junction Workflow Wizard</h1>
            <p>Answer questions to determine the correct legal speed</p>
        </div>
        
        <div class="progress-bar">
            <div class="progress-step active" data-step="1"><div class="progress-circle">1</div><div class="progress-label">Sign</div></div>
            <div class="progress-step" data-step="2"><div class="progress-circle">2</div><div class="progress-label">Country</div></div>
            <div class="progress-step" data-step="3"><div class="progress-circle">3</div><div class="progress-label">Direction</div></div>
            <div class="progress-step" data-step="4"><div class="progress-circle">4</div><div class="progress-label">Road</div></div>
            <div class="progress-step" data-step="5"><div class="progress-circle">5</div><div class="progress-label">Result</div></div>
        </div>
        
        <!-- Step 1: Explicit Sign -->
        <div class="card active" id="step1">
            <h2>Is there an explicit speed sign?</h2>
            <p class="subtitle">Check for posted speed limit signs before/at the junction</p>
            <div class="btn-group">
                <button class="btn btn-yes" onclick="selectExplicitSign(true)">‚úì YES - Sign Present</button>
                <button class="btn btn-no" onclick="selectExplicitSign(false)">‚úó NO - No Sign</button>
            </div>
        </div>
        
        <!-- Step 1b: Enter Sign Speed -->
        <div class="card" id="step1b">
            <h2>What speed does the sign show?</h2>
            <p class="subtitle">Enter the speed limit shown on the explicit sign</p>
            <div style="margin-bottom: 15px;">
                <input type="number" id="signSpeedInput" placeholder="Enter speed (e.g., 50)" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #dfe1e6; border-radius: 6px;">
                <p style="color: #6b778c; font-size: 11px; margin-top: 5px;">Enter speed in km/h</p>
            </div>
            <button class="btn" onclick="submitSignSpeed()" style="width: 100%; background: #0052cc; color: white; border-color: #0052cc;">Continue</button>
            <div class="nav-buttons"><button class="nav-btn back" onclick="goToStep(1)">‚Üê Back</button></div>
        </div>
        
        <!-- Step 2: Country Selection -->
        <div class="card" id="step2">
            <h2>Select the country</h2>
            <p class="subtitle">Choose the country for this map</p>
            <div class="country-grid" id="countryGrid"></div>
            <div class="nav-buttons"><button class="nav-btn back" onclick="goToStep(1)">‚Üê Back</button></div>
        </div>
        
        <!-- Step 3: Direction -->
        <div class="card" id="step3">
            <h2>What is your direction?</h2>
            <p class="subtitle">Are you going straight or turning?</p>
            <div class="info-box" id="propagationInfo"></div>
            <div class="btn-group">
                <button class="btn" onclick="selectDirection('straight')" id="btnStraight">‚û°Ô∏è STRAIGHT</button>
                <button class="btn" onclick="selectDirection('turn')" id="btnTurn">‚Ü™Ô∏è TURNING</button>
            </div>
            <div class="nav-buttons"><button class="nav-btn back" onclick="goToStep(2)">‚Üê Back</button></div>
        </div>
        
        <!-- Step 4: Road Type -->
        <div class="card" id="step4">
            <h2>Road type after the junction?</h2>
            <p class="subtitle" id="roadTypeSubtitle">Select the road type you're entering</p>
            <div class="btn-group" id="roadTypeButtons"></div>
            <div id="urbanSubOptions" class="sub-options" style="display: none;">
                <h3>Urban road details:</h3>
                <div class="btn-group" id="urbanSubButtons"></div>
            </div>
            <div class="nav-buttons"><button class="nav-btn back" onclick="goToStep(3)">‚Üê Back</button></div>
        </div>
        
        <!-- Step 5: Exceptions -->
        <div class="card" id="step5">
            <h2>Any exceptions?</h2>
            <p class="subtitle">Check if any apply (optional)</p>
            <div class="exception-list" id="exceptionList">
                <label class="exception-item"><input type="checkbox" value="construction" onchange="updateException(this)"><span>Construction (Conf 2)</span></label>
                <label class="exception-item"><input type="checkbox" value="school" onchange="updateException(this)"><span>School zone (Conf 6)</span></label>
                <label class="exception-item"><input type="checkbox" value="electric" onchange="updateException(this)"><span>Electric sign (Conf 4)</span></label>
                <label class="exception-item"><input type="checkbox" value="badDp" onchange="updateException(this)"><span>Bad DP (Conf 3)</span></label>
                <label class="exception-item"><input type="checkbox" value="mapEdge" onchange="updateException(this)"><span>Map edge (Conf 5)</span></label>
            </div>
            <div id="countryExceptions" class="info-box warning" style="display: none;"></div>
            <button class="btn" onclick="showResult()" style="width: 100%; background: #0052cc; color: white; border-color: #0052cc; margin-top: 10px;">Show Result</button>
            <div class="nav-buttons"><button class="nav-btn back" onclick="goBackFromExceptions()">‚Üê Back</button></div>
        </div>
        
        <!-- Step 6: Result -->
        <div class="card" id="step6">
            <div class="result-card">
                <h3>Recommended Legal Speed</h3>
                <div class="result-speed" id="resultSpeed">50</div>
                <div class="result-unit">km/h</div>
                <div class="result-confidence"><span class="confidence-badge" id="resultConfidence">Confidence: 0</span></div>
            </div>
            <div class="summary">
                <h4>Decision Summary</h4>
                <div class="summary-item"><span class="summary-label">Sign</span><span class="summary-value" id="summarySign">-</span></div>
                <div class="summary-item"><span class="summary-label">Country</span><span class="summary-value" id="summaryCountry">-</span></div>
                <div class="summary-item"><span class="summary-label">Direction</span><span class="summary-value" id="summaryDirection">-</span></div>
                <div class="summary-item"><span class="summary-label">Propagation</span><span class="summary-value" id="summaryPropagation">-</span></div>
                <div class="summary-item"><span class="summary-label">Road Type</span><span class="summary-value" id="summaryRoadType">-</span></div>
                <div class="summary-item" id="summaryExceptionRow" style="display: none;"><span class="summary-label">Exception</span><span class="summary-value" id="summaryException">-</span></div>
            </div>
            <div class="info-box success">
                <p><strong>Action:</strong> Set Legal Speed to <span id="actionSpeed">50</span> km/h with Confidence <span id="actionConfidence">0</span></p>
            </div>
            <div class="nav-buttons"><button class="nav-btn reset" onclick="resetWizard()">Start Over</button></div>
        </div>
    </div>

    <script>
        // Country Data with detailed road types
        const countries = {
            "Austria": { 
                straight: true, turn: false,
                urban: { default: 50 },
                rural: 100, highway: 130,
                exceptions: []
            },
            "Belgium": { 
                straight: false, turn: false,
                urban: { default: 50 },
                rural: 90, highway: 120,
                exceptions: []
            },
            "Croatia": { 
                straight: false, turn: false,
                urban: { default: 50 },
                rural: 90, highway: 130,
                exceptions: ["City entrance", "Tunnels", "Bridges"]
            },
            "Czechia": { 
                straight: false, turn: false,
                urban: { default: 50 },
                rural: 90, highway: 130,
                exceptions: []
            },
            "Denmark": { 
                straight: true, turn: false,
                urban: { default: 50 },
                rural: 80, highway: 130,
                exceptions: []
            },
            "Finland": { 
                straight: true, turn: false,
                urban: { default: 50 },
                rural: 80, highway: 120,
                exceptions: []
            },
            "France": { 
                straight: false, turn: false,
                urban: {
                    default: 50,
                    options: [
                        { speed: 50, label: "Standard", detail: "Normal urban road" },
                        { speed: 30, label: "30 Zone / Paris", detail: "Speed zone or Paris" },
                        { speed: 20, label: "Shared Area", detail: "Zone de rencontre" }
                    ]
                },
                rural: 80, highway: 130,
                exceptions: ["Pedestrian zone", "Speed zone", "CE signs"]
            },
            "Germany": { 
                straight: true, turn: false,
                urban: {
                    default: 50,
                    options: [
                        { speed: 50, label: "Standard", detail: "Normal urban road" },
                        { speed: 30, label: "30 Zone", detail: "Speed limit zone" },
                        { speed: 5, label: "Traffic-calmed", detail: "Verkehrsberuhigt" }
                    ]
                },
                rural: 100, highway: 254,
                exceptions: ["Danger sign", "Roundabout outside built-up"]
            },
            "Greece": { 
                straight: true, turn: false,
                urban: { default: 50 },
                rural: 90, highway: 130,
                exceptions: []
            },
            "Hungary": { 
                straight: false, turn: false,
                urban: { default: 50 },
                rural: 90, highway: 130,
                exceptions: ["Railway crossing"]
            },
            "Ireland": { 
                straight: true, turn: true,
                urban: { default: 50 },
                rural: 80, highway: 120,
                exceptions: []
            },
            "Israel": { 
                straight: false, turn: false,
                urban: { default: 50 },
                rural: 80, highway: 110,
                exceptions: ["Speed limit zones", "CE signs"]
            },
            "Italy": { 
                straight: false, turn: false,
                urban: { default: 50 },
                rural: 90, highway: 130,
                exceptions: ["Zonal validity signs", "CE signs"]
            },
            "Japan": { 
                straight: true, turn: false,
                urban: { default: 60 },
                rural: 60, highway: 100,
                exceptions: []
            },
            "Latvia": { 
                straight: false, turn: false,
                urban: { default: 50 },
                rural: 90, highway: 110,
                exceptions: []
            },
            "Luxembourg": { 
                straight: true, turn: false,
                urban: { default: 50 },
                rural: 90, highway: 130,
                exceptions: []
            },
            "Netherlands": { 
                straight: false, turn: false,
                urban: { default: 50 },
                rural: 80, highway: 130,
                exceptions: ["Parallel road mergers"]
            },
            "Norway": { 
                straight: true, turn: false,
                urban: { default: 50 },
                rural: 80, highway: 110,
                exceptions: []
            },
            "Poland": { 
                straight: false, turn: false,
                urban: { default: 50 },
                rural: 90, highway: 140,
                exceptions: []
            },
            "Portugal": { 
                straight: false, turn: false,
                urban: { default: 50 },
                rural: 90, highway: 120,
                exceptions: ["CE + speed sign"]
            },
            "South Korea": { 
                straight: true, turn: false,
                urban: { default: 60 },
                rural: 80, highway: 110,
                exceptions: []
            },
            "Spain": { 
                straight: true, turn: false,
                urban: {
                    default: 50,
                    options: [
                        { speed: 50, label: "2+ lanes", detail: "Two or more lanes per direction" },
                        { speed: 30, label: "1 lane", detail: "Single lane per direction" },
                        { speed: 20, label: "Shared", detail: "Single platform (road + sidewalk)" }
                    ]
                },
                rural: 90, highway: 120,
                exceptions: ["Non-priority road", "Danger sign on pole", "Traves√≠a = 50"]
            },
            "Sweden": { 
                straight: true, turn: true,
                urban: { default: 50 },
                rural: 70, highway: 110,
                exceptions: []
            },
            "Switzerland": { 
                straight: false, turn: false,
                urban: { default: 50 },
                rural: 80, highway: 120,
                exceptions: []
            },
            "UK": { 
                straight: true, turn: true,
                urban: { default: 48 },
                rural: 96, highway: 112,
                exceptions: [],
                note: "30/60/70 mph"
            },
            "USA": { 
                straight: true, turn: true,
                urban: { default: 40 },
                rural: 88, highway: 104,
                exceptions: ["Advisory signs", "Residential signs"],
                note: "25/55/65 mph"
            }
        };

        let state = { explicitSign: null, signSpeed: null, country: null, direction: null, roadType: null, urbanDetail: null, exception: null, confidence: 0 };

        function initCountryGrid() {
            const grid = document.getElementById('countryGrid');
            Object.keys(countries).sort().forEach(country => {
                const btn = document.createElement('button');
                btn.className = 'btn country-btn';
                btn.textContent = country;
                btn.onclick = () => selectCountry(country);
                grid.appendChild(btn);
            });
        }

        function goToStep(step) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById(step === '1b' ? 'step1b' : `step${step}`).classList.add('active');
            updateProgressBar(step);
        }

        function updateProgressBar(currentStep) {
            const stepNum = currentStep === '1b' ? 1 : parseInt(currentStep);
            document.querySelectorAll('.progress-step').forEach((step, i) => {
                step.classList.remove('active', 'completed');
                if (i + 1 < stepNum) step.classList.add('completed');
                else if (i + 1 === stepNum) step.classList.add('active');
            });
        }

        function selectExplicitSign(hasSign) {
            state.explicitSign = hasSign;
            goToStep(hasSign ? '1b' : 2);
        }

        function submitSignSpeed() {
            const speed = document.getElementById('signSpeedInput').value;
            if (speed && parseInt(speed) > 0) {
                state.signSpeed = parseInt(speed);
                state.confidence = 0;
                showFinalResult();
            }
        }

        function selectCountry(country) {
            state.country = country;
            document.querySelectorAll('.country-btn').forEach(btn => btn.classList.toggle('selected', btn.textContent === country));
            const c = countries[country];
            document.getElementById('propagationInfo').innerHTML = `<p><strong>${country}:</strong> Straight: ${c.straight ? '‚úÖ Keep' : '‚ùå Reset'} | Turn: ${c.turn ? '‚úÖ Keep' : '‚ùå Reset'}${c.note ? '<br><em>' + c.note + '</em>' : ''}</p>`;
            buildRoadTypeButtons(country);
            setTimeout(() => goToStep(3), 200);
        }

        function buildRoadTypeButtons(country) {
            const c = countries[country];
            const container = document.getElementById('roadTypeButtons');
            container.innerHTML = '';
            
            // Urban button
            const urbanBtn = document.createElement('button');
            urbanBtn.className = 'btn road-type-btn';
            urbanBtn.id = 'btnUrban';
            urbanBtn.innerHTML = `<span class="icon">üèôÔ∏è</span><span class="label">Urban</span><span class="speed">${c.urban.default} km/h</span>${c.urban.options ? '<span class="detail">Click for options</span>' : ''}`;
            urbanBtn.onclick = () => selectRoadType('urban');
            container.appendChild(urbanBtn);
            
            // Rural button
            const ruralBtn = document.createElement('button');
            ruralBtn.className = 'btn road-type-btn';
            ruralBtn.id = 'btnRural';
            ruralBtn.innerHTML = `<span class="icon">üåÑ</span><span class="label">Rural</span><span class="speed">${c.rural} km/h</span>`;
            ruralBtn.onclick = () => selectRoadType('rural');
            container.appendChild(ruralBtn);
            
            // Highway button
            const hwBtn = document.createElement('button');
            hwBtn.className = 'btn road-type-btn';
            hwBtn.id = 'btnHighway';
            hwBtn.innerHTML = `<span class="icon">üõ£Ô∏è</span><span class="label">Highway</span><span class="speed">${c.highway === 254 ? '‚àû' : c.highway + ' km/h'}</span>`;
            hwBtn.onclick = () => selectRoadType('highway');
            container.appendChild(hwBtn);
            
            // Build urban sub-options if available
            const subContainer = document.getElementById('urbanSubButtons');
            const subSection = document.getElementById('urbanSubOptions');
            subContainer.innerHTML = '';
            
            if (c.urban.options) {
                c.urban.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn road-type-btn';
                    btn.innerHTML = `<span class="speed" style="font-size: 16px; font-weight: 600;">${opt.speed}</span><span class="label">${opt.label}</span><span class="detail">${opt.detail}</span>`;
                    btn.onclick = () => selectUrbanDetail(opt.speed, opt.label);
                    subContainer.appendChild(btn);
                });
            }
        }

        function selectDirection(direction) {
            state.direction = direction;
            const c = countries[state.country];
            const propagates = direction === 'straight' ? c.straight : c.turn;
            document.getElementById('btnStraight').classList.toggle('selected', direction === 'straight');
            document.getElementById('btnTurn').classList.toggle('selected', direction === 'turn');
            if (propagates) {
                state.roadType = 'keep';
                state.confidence = 0;
                setTimeout(() => goToStep(5), 200);
            } else {
                setTimeout(() => goToStep(4), 200);
            }
        }

        function selectRoadType(type) {
            state.roadType = type;
            state.urbanDetail = null;
            state.confidence = 0;
            
            document.querySelectorAll('#roadTypeButtons .btn').forEach(btn => btn.classList.remove('selected'));
            
            const c = countries[state.country];
            const subSection = document.getElementById('urbanSubOptions');
            
            if (type === 'urban' && c.urban.options) {
                document.getElementById('btnUrban').classList.add('selected');
                subSection.style.display = 'block';
                return; // Wait for sub-selection
            } else {
                subSection.style.display = 'none';
            }
            
            if (type === 'urban') document.getElementById('btnUrban').classList.add('selected');
            else if (type === 'rural') document.getElementById('btnRural').classList.add('selected');
            else if (type === 'highway') document.getElementById('btnHighway').classList.add('selected');
            
            showCountryExceptions();
            setTimeout(() => goToStep(5), 200);
        }

        function selectUrbanDetail(speed, label) {
            state.urbanDetail = { speed, label };
            document.querySelectorAll('#urbanSubButtons .btn').forEach(btn => btn.classList.remove('selected'));
            event.target.closest('.btn').classList.add('selected');
            
            showCountryExceptions();
            setTimeout(() => goToStep(5), 200);
        }

        function showCountryExceptions() {
            const c = countries[state.country];
            const exceptionsDiv = document.getElementById('countryExceptions');
            if (c.exceptions.length > 0) {
                exceptionsDiv.innerHTML = `<p><strong>${state.country} specific notes:</strong><br>‚Ä¢ ${c.exceptions.join('<br>‚Ä¢ ')}</p>`;
                exceptionsDiv.style.display = 'block';
            } else {
                exceptionsDiv.style.display = 'none';
            }
        }

        function updateException(checkbox) {
            if (checkbox.checked) {
                document.querySelectorAll('.exception-list input').forEach(cb => { if (cb !== checkbox) cb.checked = false; });
                state.exception = checkbox.value;
                state.confidence = { 'construction': 2, 'school': 6, 'electric': 4, 'badDp': 3, 'mapEdge': 5 }[checkbox.value] || 0;
            } else {
                state.exception = null;
                state.confidence = 0;
            }
        }

        function goBackFromExceptions() {
            const c = countries[state.country];
            goToStep((state.direction === 'straight' ? c.straight : c.turn) ? 3 : 4);
        }

        function showResult() { showFinalResult(); }

        function showFinalResult() {
            let speed, roadTypeLabel = '-';
            let summary = {};
            
            if (state.explicitSign && state.signSpeed) {
                speed = state.signSpeed;
                summary = { sign: `Yes (${speed})`, country: '-', direction: '-', propagation: '-', roadType: '-' };
            } else {
                const c = countries[state.country];
                const propagates = state.direction === 'straight' ? c.straight : c.turn;
                
                if (propagates) {
                    speed = 'KEEP';
                    summary = { sign: 'No', country: state.country, direction: state.direction === 'straight' ? 'Straight' : 'Turn', propagation: '‚úÖ Keep', roadType: 'N/A' };
                } else {
                    if (state.roadType === 'urban') {
                        if (state.urbanDetail) {
                            speed = state.urbanDetail.speed;
                            roadTypeLabel = `Urban (${state.urbanDetail.label})`;
                        } else {
                            speed = c.urban.default;
                            roadTypeLabel = 'Urban';
                        }
                    } else if (state.roadType === 'rural') {
                        speed = c.rural;
                        roadTypeLabel = 'Rural';
                    } else {
                        speed = c.highway;
                        roadTypeLabel = 'Highway';
                    }
                    summary = { sign: 'No', country: state.country, direction: state.direction === 'straight' ? 'Straight' : 'Turn', propagation: '‚ùå Reset', roadType: roadTypeLabel };
                }
            }
            
            document.getElementById('resultSpeed').textContent = speed === 'KEEP' ? 'KEEP' : (speed === 254 ? '‚àû' : speed);
            document.getElementById('resultConfidence').textContent = `Confidence: ${state.confidence}`;
            document.getElementById('summarySign').textContent = summary.sign;
            document.getElementById('summaryCountry').textContent = summary.country;
            document.getElementById('summaryDirection').textContent = summary.direction;
            document.getElementById('summaryPropagation').textContent = summary.propagation;
            document.getElementById('summaryRoadType').textContent = summary.roadType;
            
            if (state.exception) {
                document.getElementById('summaryExceptionRow').style.display = 'flex';
                document.getElementById('summaryException').textContent = { 'construction': 'Construction', 'school': 'School', 'electric': 'Electric', 'badDp': 'Bad DP', 'mapEdge': 'Map edge' }[state.exception];
            } else {
                document.getElementById('summaryExceptionRow').style.display = 'none';
            }
            
            const actionSpeed = speed === 'KEEP' ? 'entering' : (speed === 254 ? '‚àû' : speed);
            document.getElementById('actionSpeed').textContent = actionSpeed;
            document.getElementById('actionConfidence').textContent = state.confidence;
            
            goToStep(6);
            updateProgressBar(5);
        }

        function resetWizard() {
            state = { explicitSign: null, signSpeed: null, country: null, direction: null, roadType: null, urbanDetail: null, exception: null, confidence: 0 };
            document.getElementById('signSpeedInput').value = '';
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.exception-list input').forEach(cb => cb.checked = false);
            document.getElementById('urbanSubOptions').style.display = 'none';
            goToStep(1);
        }

        initCountryGrid();
    </script>
</body> 
</html>
